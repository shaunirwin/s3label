<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="static/fetch_data.js"></script> -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous"> -->
    <title>S3 Label</title>
</head>

<body>

    <h1>S3 Label</h1>

    <div id="drawingtools">
        <div id="tools">
            <span>Tools</span>
            <form>
                <input type="radio" name="tool" value="freehand" checked> Freehand
                <br>
                <input type="radio" name="tool" value="polygon"> Polygon
            </form>
        </div>
        <div id="semantic_labels">
            <span>Semantic Labels</span>
            <form>
                <input type="radio" name="semantic_label" value="individual_rock" checked> Individual rock
                <br>
                <input type="radio" name="semantic_label" value="belt"> Belt
                <br>
                <input type="radio" name="semantic_label" value="other"> Other
            </form>
        </div>
    </div>

    <div id="canvasesdiv" style="position:relative; width:500px; height:300px">
        <canvas id="c" width="500" height="300" style="border: 1px solid #ccc; z-index: 2; position:absolute; left:0px; top:0px;"></canvas>
        <canvas id="c2" width="500" height="300" style="border: 1px solid #ccc; z-index: 1; position:absolute; left:0px; top:0px;"></canvas>
    </div>

    <script>
        var el = document.getElementById('c');
        var el2 = document.getElementById('c2');
        var ctx = el.getContext('2d');
        var ctx2 = el2.getContext('2d');
        var isDrawing;
        var paths = [];
        var currentPath = [];
        var paths_redo = [];
        var colours = {
            'individual_rock': [255, 0, 0],
            'belt': [0, 255, 0],
            'other': [0, 0, 255]
        };
        var opacity = 0.2;
        var active_label = 'individual_rock';

        ctx.lineWidth = 3;
        ctx.fillStyle = setColour(colours[active_label], opacity);

        ctx2.fillStyle = 'rgba(0, 255, 255, 0.2)';
        ctx2.fillRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);

        window.addEventListener('keydown', this.keyHandler, false);

        function keyHandler(e) {
            if (e.ctrlKey && e.code === "KeyU") {
                console.log("Undo");
                undo();
                drawAllPolygons(ctx, paths);
            }
            else if (e.ctrlKey && e.code === "KeyR") {
                console.log("Redo");
                redo();
                drawAllPolygons(ctx, paths);
            }

            e.stopPropagation();
            e.preventDefault();
        }

        function getMousePos(canvas, event) {
            // https://stackoverflow.com/questions/17130395/real-mouse-position-in-canvas
            var rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        el.onmousedown = function (e) {
            paths_redo = [];
            isDrawing = true;
            ctx.lineJoin = ctx.lineCap = 'round';
            ctx.beginPath();
            coords = getMousePos(ctx.canvas, e);
            ctx.moveTo(coords.x, coords.y);
            currentPath.push([coords.x, coords.y]);
        };
        el.onmousemove = function (e) {
            if (isDrawing) {
                coords = getMousePos(ctx.canvas, e);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                currentPath.push([coords.x, coords.y]);
            }
        };
        el.onmouseup = function () {
            isDrawing = false;

            ctx.closePath();
            ctx.stroke();
            ctx.fill();

            // drawPolygon(ctx2, currentPath);


            console.log("currentPath: " + currentPath);

            paths.push({ 'path': currentPath, 'label': active_label });
            currentPath = [];

            drawAllPolygons(ctx, paths);
        };

        function undo() {
            if (paths.length > 0) {
                paths_redo.push(paths.pop());
            }
        }

        function redo() {
            if (paths_redo.length > 0) {
                paths.push(paths_redo.pop());
            }
        }

        function drawAllPolygons(context, path_list) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);

            for (let i = 0; i < path_list.length; i++) {
                setColour(colours[path_list[i].label], opacity);
                drawPolygon(context, path_list[i].path);
                console.log("Drawing polygon " + i + ' label: ' + path_list[i].label + ' colour: ' + context.fillStyle);
            }
            console.log("Num paths:" + path_list.length);
        }

        function drawPolygon(context, path) {
            context.beginPath();
            context.moveTo(path[0][0], path[0][1]);

            for (let i = 1; i < path.length; i++) {
                context.lineTo(path[i][0], path[i][1]);
            }

            context.closePath();
            context.stroke();
            context.fill();
        }

        // detect tool and colour changes

        var toolRadioButtons = document.getElementsByName("tool");
        var semanticLabelRadioButtons = document.getElementsByName("semantic_label");

        for (var i = 0; toolRadioButtons[i]; i++)
            toolRadioButtons[i].onclick = setActiveTool;

        for (var i = 0; semanticLabelRadioButtons[i]; i++)
            semanticLabelRadioButtons[i].onclick = setActiveLabel;

        function setActiveTool() {
            active_tool = document.querySelector('input[name="tool"]:checked').value;
            console.log("active_tool: " + active_tool);
        }

        function formatColour(rgb, alpha) {
            return 'rgba(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ',' + alpha + ')';
        }

        function setColour(rgb, alpha) {
            ctx.fillStyle = formatColour(rgb, alpha);
        }

        function setActiveLabel() {
            active_label = label_class = document.querySelector('input[name="semantic_label"]:checked').value;
            setColour(colours[active_label], opacity);
            console.log("active_label: " + active_label);
        }
    </script>
</body>

</html>