<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="static/fetch_data.js"></script> -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous"> -->
    <title>S3 Label</title>
</head>

<body>

    <h1>A Title</h1>

    <canvas id="c" width="500" height="300" style="border: 1px solid #ccc"></canvas>
    <canvas id="c2" width="500" height="300" style="border: 1px solid #ccc"></canvas>

    <script>
        var el = document.getElementById('c');
        var el2 = document.getElementById('c2');
        var ctx = el.getContext('2d');
        var ctx2 = el2.getContext('2d');
        var isDrawing;
        var paths = [];
        var currentPath = [];
        var paths_redo = [];

        ctx.lineWidth = 3;
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';


        window.addEventListener('keydown', this.keyHandler, false);

        function keyHandler(e) {
            if (e.ctrlKey && e.code === "KeyU") {
                console.log("Undo");
                undo();
                drawAllPolygons(ctx, paths);
            }
            else if (e.ctrlKey && e.code === "KeyR") {
                console.log("Redo");
                redo();
                drawAllPolygons(ctx, paths);
            }

            e.stopPropagation();
            e.preventDefault();
        }

        function getMousePos(canvas, event) {
            // https://stackoverflow.com/questions/17130395/real-mouse-position-in-canvas
            var rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        el.onmousedown = function (e) {
            paths_redo = [];
            isDrawing = true;
            ctx.lineJoin = ctx.lineCap = 'round';
            ctx.beginPath();
            coords = getMousePos(ctx.canvas, e);
            ctx.moveTo(coords.x, coords.y);
            currentPath.push([coords.x, coords.y]);
        };
        el.onmousemove = function (e) {
            if (isDrawing) {
                coords = getMousePos(ctx.canvas, e);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                currentPath.push([coords.x, coords.y]);
            }
        };
        el.onmouseup = function () {
            isDrawing = false;

            ctx.closePath();
            ctx.stroke();
            ctx.fill();

            // drawPolygon(ctx2, currentPath);


            console.log("currentPath: " + currentPath);

            paths.push(currentPath);
            currentPath = [];

            drawAllPolygons(ctx, paths);
        };

        function undo() {
            if (paths.length > 0) {
                paths_redo.push(paths.pop());
            }
        }

        function redo() {
            if (paths_redo.length > 0) {
                paths.push(paths_redo.pop());
            }
        }

        function drawAllPolygons(context, path_list) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);

            for (let i = 0; i < path_list.length; i++) {
                drawPolygon(context, path_list[i]);
                console.log("Drawing polygon " + i);
            }
            console.log("Num paths:" + path_list.length);
        }

        function drawPolygon(context, path) {
            context.beginPath();
            context.moveTo(path[0][0], path[0][1]);

            for (let i = 1; i < path.length; i++) {
                context.lineTo(path[i][0], path[i][1]);
            }

            context.closePath();
            context.stroke();
            context.fill();
        }
    </script>
</body>

</html>